{% extends "base.html" %}

{% block title %}Регистрация - Реестр школ Алтайского края{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header bg-success text-white text-center">
                <h4 class="mb-0"><i class="bi bi-person-plus"></i> Регистрация</h4>
            </div>
            <div class="card-body">
                <!-- Flash сообщения -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show mb-4" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <form method="POST" action="{{ url_for('register') }}" class="needs-validation" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <!-- Имя пользователя -->
                    <div class="mb-3">
                        <label for="username" class="form-label">Имя пользователя</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-person"></i>
                            </span>
                            {{ form.username(class="form-control", placeholder="Введите имя пользователя", required=true) }}
                        </div>
                        <div class="invalid-feedback">
                            Пожалуйста, введите имя пользователя (минимум 3 символа).
                        </div>
                        {% if form.username.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.username.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-envelope"></i>
                            </span>
                            {{ form.email(class="form-control", placeholder="Введите email", required=true) }}
                        </div>
                        <div class="invalid-feedback">
                            Пожалуйста, введите корректный email.
                        </div>
                        {% if form.email.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.email.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Пароль -->
                    <div class="mb-3">
                        <label for="password" class="form-label">Пароль</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-key"></i>
                            </span>
                            {{ form.password(class="form-control", placeholder="Введите пароль (минимум 6 символов)", required=true) }}
                        </div>
                        <div class="invalid-feedback">
                            Пароль должен быть не менее 6 символов.
                        </div>
                        <div class="form-text">
                            <div id="password-strength" class="mt-2">
                                <div class="progress" style="height: 8px;">
                                    <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="password-strength-text" class="text-muted">Сложность пароля: очень слабый</small>
                            </div>
                        </div>
                        {% if form.password.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.password.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Повтор пароля -->
                    <div class="mb-3">
                        <label for="password2" class="form-label">Повторите пароль</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-key-fill"></i>
                            </span>
                            {{ form.password2(class="form-control", placeholder="Повторите пароль", required=true) }}
                        </div>
                        <div class="invalid-feedback">
                            Пароли должны совпадать.
                        </div>
                        <div id="password-match" class="form-text">
                            <small id="password-match-text"></small>
                        </div>
                        {% if form.password2.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.password2.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Роль -->
                    <div class="mb-3">
                        <label for="role" class="form-label">Выберите вашу роль</label>
                        {{ form.role(class="form-select", required=true) }}
                        <div class="form-text">
                            <small>
                                <strong>Ученик/Родитель:</strong> только просмотр информации<br>
                                <strong>Работник учреждения:</strong> может редактировать данные своей школы<br>
                                <strong>Другое:</strong> только просмотр информации
                            </small>
                        </div>
                    </div>
                    
                    <!-- Выбор учреждения (только для работников) -->
                    <div class="mb-3" id="school-field" style="display: none;">
                        <label for="school_id" class="form-label">Выберите ваше образовательное учреждение</label>
                        {{ form.school_id(class="form-select", required=false) }}
                        <div class="invalid-feedback">
                            Для работника учреждения необходимо выбрать учреждение.
                        </div>
                        {% if form.school_id.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.school_id.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        {{ form.submit(class="btn btn-success btn-lg") }}
                    </div>
                </form>
                
                <hr class="my-4">
                
                <div class="text-center">
                    <p class="mb-2">Уже есть аккаунт?</p>
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Войти
                    </a>
                </div>
            </div>
            <div class="card-footer text-center">
                <small class="text-muted">
                    Регистрируясь, вы соглашаетесь с условиями использования и политикой конфиденциальности.
                </small>
            </div>
        </div>
        
        <!-- Информация о ролях -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Информация о ролях</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body py-3">
                                <h6 class="card-title">Ученик/Родитель</h6>
                                <ul class="small mb-0">
                                    <li>Просмотр информации о школах</li>
                                    <li>Оставление отзывов</li>
                                    <li>Поиск школ по фильтрам</li>
                                    <li>Не может редактировать данные</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body py-3">
                                <h6 class="card-title">Работник учреждения</h6>
                                <ul class="small mb-0">
                                    <li>Все права ученика/родителя</li>
                                    <li>Редактирование данных своей школы</li>
                                    <li>Управление отзывами своей школы</li>
                                    <li>Добавление сотрудников и программ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('role');
    const schoolField = document.getElementById('school-field');
    const schoolSelect = document.getElementById('school_id');
    const passwordInput = document.getElementById('password');
    const passwordStrengthBar = document.getElementById('password-strength-bar');
    const passwordStrengthText = document.getElementById('password-strength-text');
    const password2Input = document.getElementById('password2');
    const passwordMatchText = document.getElementById('password-match-text');
    
    // Показать/скрыть поле выбора школы
    function toggleSchoolField() {
        if (roleSelect.value === '2') {
            schoolField.style.display = 'block';
            schoolSelect.required = true;
        } else {
            schoolField.style.display = 'none';
            schoolSelect.required = false;
        }
    }
    
    roleSelect.addEventListener('change', toggleSchoolField);
    toggleSchoolField(); // Инициализация
    
    // Проверка сложности пароля
    function checkPasswordStrength(password) {
        let strength = 0;
        
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]+/)) strength++;
        if (password.match(/[A-Z]+/)) strength++;
        if (password.match(/[0-9]+/)) strength++;
        if (password.match(/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/)) strength++;
        
        return strength;
    }
    
    function updatePasswordStrength() {
        const password = passwordInput.value;
        const strength = checkPasswordStrength(password);
        const strengthPercent = (strength / 5) * 100;
        
        passwordStrengthBar.style.width = strengthPercent + '%';
        
        let color, text;
        switch(strength) {
            case 0:
            case 1:
                color = 'bg-danger';
                text = 'Очень слабый';
                break;
            case 2:
                color = 'bg-warning';
                text = 'Слабый';
                break;
            case 3:
                color = 'bg-info';
                text = 'Средний';
                break;
            case 4:
                color = 'bg-primary';
                text = 'Хороший';
                break;
            case 5:
                color = 'bg-success';
                text = 'Отличный';
                break;
        }
        
        passwordStrengthBar.className = 'progress-bar ' + color;
        passwordStrengthText.textContent = 'Сложность пароля: ' + text;
    }
    
    passwordInput.addEventListener('input', updatePasswordStrength);
    
    // Проверка совпадения паролей
    function checkPasswordMatch() {
        const password = passwordInput.value;
        const password2 = password2Input.value;
        
        if (!password2) {
            passwordMatchText.textContent = '';
            passwordMatchText.className = '';
            return;
        }
        
        if (password === password2) {
            passwordMatchText.textContent = '✓ Пароли совпадают';
            passwordMatchText.className = 'text-success';
        } else {
            passwordMatchText.textContent = '✗ Пароли не совпадают';
            passwordMatchText.className = 'text-danger';
        }
    }
    
    passwordInput.addEventListener('input', checkPasswordMatch);
    password2Input.addEventListener('input', checkPasswordMatch);
    
    // Валидация формы
    const forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                // Показать сообщения об ошибках
                if (roleSelect.value === '2' && schoolSelect.value === '0') {
                    event.preventDefault();
                    schoolSelect.classList.add('is-invalid');
                    const errorDiv = schoolSelect.nextElementSibling;
                    if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                        errorDiv.textContent = 'Для работника учреждения необходимо выбрать учреждение.';
                        errorDiv.style.display = 'block';
                    }
                }
            }
            form.classList.add('was-validated');
        }, false);
    });
});
</script>
{% endblock %}